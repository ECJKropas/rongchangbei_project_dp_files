name: Auto Release DP Files

permissions:
  contents: write
  releases: write  # Added this required permission

on:
  push:
    paths:
      - 'dp_files/**'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate manifest
        id: manifest
        run: |
          # Generate timestamp for tag
          echo "TIMESTAMP=$(date +%s)" >> $GITHUB_ENV
          
          # Generate manifest.json
          echo '{ "last_updated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")", "resources": [' > manifest.json
          find dp_files -name "*.dp" | while read file; do
            sha=$(sha256sum "$file" | awk '{print $1}')
            echo "{
              \"file\": \"$(basename $file)\",
              \"url\": \"https://github.com/${{ github.repository }}/releases/download/v${TIMESTAMP}/$(basename $file)\",
              \"sha256\": \"$sha\"
            }," >> manifest.json
          done
          sed -i '$ s/,$//' manifest.json
          echo ']}' >> manifest.json

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ env.TIMESTAMP }}"
          name: "Release v${{ env.TIMESTAMP }}"
          files: |
            manifest.json
            dp_files/*.dp  # Adjusted to match your actual file structure
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
